# Get the branch name
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)

# This script runs linting, type checking, and builds before allowing a commit.
echo 'ğŸ› ï¸  Preparing to commit: Running linting, type checking, and build'

# Run lint-staged for ESLint/Prettier fixes on staged files
echo "ğŸ” Running lint-staged (ESLint/Prettier)..."
npx lint-staged ||
(
  echo 'âŒ Lint-staged failed. Please fix ESLint/Prettier issues and try committing again.'
  exit 1
)

# Run TypeScript type checking
echo "ğŸ” Running TypeScript type checking..."
npm run typecheck ||
(
  echo 'âŒ TypeScript type checking failed. Please fix the type errors before committing.'
  exit 1
)

# Run npm audit check for vulnerabilities
echo "ğŸ” Running npm audit check..."
npm audit --audit-level=moderate ||
(
  echo 'âŒ npm audit found vulnerabilities. Please fix them before committing.'
  exit 1
)

# Run build only for main branch
if [ "$BRANCH_NAME" = "main" ]; then
  echo "ğŸ—ï¸  Running build for main branch..."
  npm run build ||
  (
    echo 'âŒ Build failed. Please ensure the build process completes successfully before committing.'
    exit 1
  )
fi

# All checks passed, allow the commit
echo 'âœ… All pre-commit checks passed. You may now commit your changes.'